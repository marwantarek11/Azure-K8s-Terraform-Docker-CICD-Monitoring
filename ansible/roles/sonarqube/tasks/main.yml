---
# Install Java (required for SonarQube and SonarScanner)
- name: Update apt cache
  apt:
    update_cache: yes

- name: Install Java {{ java_version }}
  apt:
    name: "{{ java_version }}"
    state: present

# Install SonarQube
- name: Create SonarQube user
  user:
    name: "{{ sonarqube_user }}"
    system: yes
    shell: /bin/bash

- name: Install unzip
  apt:
    name: unzip
    state: present

- name: Download SonarQube
  get_url:
    url: "{{ sonarqube_zip_url }}"
    dest: "{{ sonarqube_zip_dest }}"

- name: Extract SonarQube
  unarchive:
    src: "{{ sonarqube_zip_dest }}"
    dest: "{{ sonarqube_extract_dest }}"
    remote_src: yes

- name: Rename SonarQube directory
  command: mv /opt/sonarqube-10.3.0.82913 "{{ sonarqube_dir }}"
  args:
    creates: "{{ sonarqube_dir }}"

- name: Change ownership of SonarQube directory
  file:
    path: "{{ sonarqube_dir }}"
    owner: "{{ sonarqube_user }}"
    group: "{{ sonarqube_user }}"
    recurse: yes

- name: Create SonarQube service file
  copy:
    dest: "{{ sonarqube_service_file }}"
    content: "{{ sonarqube_service_content }}"

- name: Start SonarQube service
  service:
    name: "{{ sonarqube_service }}"
    state: started
    enabled: yes
    daemon_reload: yes

# Install SonarScanner
- name: Download SonarScanner
  shell: wget -O /tmp/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-7.0.1.4817-linux-x64.zip

- name: Check if download was successful
  stat:
    path: /tmp/sonar-scanner.zip
  register: zip_file

- name: Fail if download failed
  fail:
    msg: "SonarScanner download failed - file is empty or not found"
  when: not zip_file.stat.exists or zip_file.stat.size == 0

- name: Extract SonarScanner
  unarchive:
    src: /tmp/sonar-scanner.zip
    dest: /opt/
    remote_src: yes

- name: Rename SonarScanner directory
  command: mv /opt/sonar-scanner-7.0.1.4817-linux-x64 /opt/sonarscanner
  args:
    creates: /opt/sonarscanner

- name: Configure SonarScanner
  lineinfile:
    path: /opt/sonarscanner/conf/sonar-scanner.properties
    regexp: '^#sonar.host.url=http://localhost:9000'
    line: 'sonar.host.url=http://localhost:9000'
    state: present

- name: Set execute permissions on sonar-scanner binary
  file:
    path: /opt/sonarscanner/bin/sonar-scanner
    mode: '0755'

- name: Create symlink for sonar-scanner
  file:
    src: /opt/sonarscanner/bin/sonar-scanner
    dest: /usr/local/bin/sonar-scanner
    state: link
